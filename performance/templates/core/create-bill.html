{% extends 'base.html' %}
{% load static %}

{% block style-content %}
<link rel="stylesheet" href="{% static 'css/create-bill-complete.css' %}">
{% endblock style-content %}


{% block content %}
<div class="bill-page-container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-title">
            <span class="material-icons-sharp">receipt_long</span>
            <h1>Create Bills</h1>
        </div>
        <div class="quick-stats">
            <div class="stat-item">
                <span class="stat-value">{{ total_bills_today }}</span>
                <span class="stat-label">Bills Today</span>
            </div>
            <div class="stat-item">
                <span class="stat-value">${{ total_revenue_today|floatformat:2 }}</span>
                <span class="stat-label">Revenue Today</span>
            </div>
        </div>
    </div>

    <!-- Multi-Bill Tabs -->
    <div class="bill-tabs-container">
        <div class="bill-tabs" id="billTabs">
            <div class="bill-tab active" data-bill="1" onclick="switchBill(1)">
                <span class="tab-number">#1</span>
                <span>Bill 1</span>
                <span class="close-tab" onclick="closeBill(event, 1)">Ã—</span>
            </div>
        </div>
        <div class="tab-actions">
            <button class="add-bill-btn" onclick="addNewBill()">
                <span class="material-icons-sharp">add</span>
                Add New Bill
            </button>
            <button class="save-all-btn" onclick="saveAllBills()">
                <span class="material-icons-sharp">save</span>
                Save All Bills (1)
            </button>
        </div>
    </div>

    <!-- Bill Forms Container -->
    <div id="billFormsContainer">
        <!-- Bill 1 (Default) -->
        <div class="bill-content active" data-bill="1">
            <form class="bill-form" data-bill-number="1">
                {% csrf_token %}
                
                <!-- Client Information -->
                <div class="form-grid">
                    <div class="form-group">
                        <label>
                            <span class="material-icons-sharp" style="font-size: 16px;">person</span>
                            Select Existing Client
                        </label>
                        <select class="clientSelect" name="clientSelect" onchange="fillClientData(this, 1)">
                            <option value="">-- New Client --</option>
                            {% for client in clients %}
                            <option value="{{ client.lid }}" 
                                    data-name="{{ client.full_name }}"
                                    data-phone="{{ client.phone }}"
                                    data-email="{{ client.email }}"
                                    data-address="{{ client.address }}"
                                    data-city="{{ client.city }}"
                                    data-country="{{ client.country }}"
                                    data-postal="{{ client.postal_code }}">
                                {{ client.full_name }} - {{ client.phone }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            Client Name <span class="required">*</span>
                        </label>
                        <input type="text" class="clientName" name="clientName" placeholder="Enter client name" required>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <span class="material-icons-sharp" style="font-size: 16px;">phone</span>
                            Phone
                        </label>
                        <input type="tel" class="phone" name="phone" placeholder="+1 234 567 8900">
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <span class="material-icons-sharp" style="font-size: 16px;">email</span>
                            Email
                        </label>
                        <input type="email" class="email" name="email" placeholder="client@example.com">
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <span class="material-icons-sharp" style="font-size: 16px;">location_on</span>
                            Address
                        </label>
                        <input type="text" class="address" name="address" placeholder="Street address">
                    </div>
                    
                    <div class="form-group">
                        <label>City</label>
                        <input type="text" class="city" name="city" placeholder="City">
                    </div>
                    
                    <div class="form-group">
                        <label>Country</label>
                        <input type="text" class="country" name="country" placeholder="Country">
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <span class="material-icons-sharp" style="font-size: 16px;">calendar_today</span>
                            Bill Date <span class="required">*</span>
                        </label>
                        <input type="date" class="billDate" name="billDate" required value="{% now 'Y-m-d' %}">
                    </div>
                </div>

                <!-- Items Section -->
                <div class="items-section">
                    <div class="section-header">
                        <h3>
                            <span class="material-icons-sharp">list</span>
                            Bill Items
                        </h3>
                        <button type="button" class="add-item-btn" onclick="addItem(1)">
                            <span class="material-icons-sharp">add_circle</span>
                            Add Item
                        </button>
                    </div>
                    
                    <div class="items-table-container">
                        <table class="items-table">
                            <thead>
                                <tr>
                                    <th style="width: 5%;">#</th>
                                    <th style="width: 35%;">Description</th>
                                    <th style="width: 15%;">Price</th>
                                    <th style="width: 15%;">Quantity</th>
                                    <th style="width: 20%;">Amount</th>
                                    <th style="width: 10%;">Action</th>
                                </tr>
                            </thead>
                            <tbody class="items-body">
                                <tr class="item-row">
                                    <td>1</td>
                                    <td>
                                        <input type="text" class="item-title" placeholder="Item description" required>
                                    </td>
                                    <td>
                                        <input type="number" class="item-price" placeholder="0.00" step="0.01" min="0" value="0" oninput="calculateRowTotal(this)">
                                    </td>
                                    <td>
                                        <input type="number" class="item-quantity" placeholder="1" min="1" value="1" oninput="calculateRowTotal(this)">
                                    </td>
                                    <td>
                                        <input type="number" class="item-amount" placeholder="0.00" readonly style="background: #f1f5f9; font-weight: 600;">
                                    </td>
                                    <td>
                                        <button type="button" class="remove-item-btn" onclick="removeItem(this, 1)">
                                            <span class="material-icons-sharp" style="font-size: 16px;">delete</span>
                                            Remove
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Bill Summary -->
                <div class="bill-summary">
                    <div class="summary-row">
                        <span class="summary-label">Total Items:</span>
                        <span class="summary-value total-items">1</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Total Quantity:</span>
                        <span class="summary-value total-quantity">1</span>
                    </div>
                    <div class="summary-row">
                        <span class="summary-label">Total Amount:</span>
                        <span class="summary-value total-amount">$0.00</span>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Recent Bills Section -->
    <div class="recent-bills-section">
        <div class="section-title">
            <h2>
                <span class="material-icons-sharp">history</span>
                Recent Bills
            </h2>
            <a href="{% url 'core:dashboard' %}" class="view-all-btn">
                View All
                <span class="material-icons-sharp">arrow_forward</span>
            </a>
        </div>
        
        {% if recent_bills %}
        <div class="bills-grid">
            {% for bill in recent_bills %}
            <div class="bill-card" onclick="window.location.href='{% url 'core:client_detail' bill.client.lid %}'">
                <div class="bill-card-header">
                    <div class="bill-id">#{{ bill.id }}</div>
                    <div class="bill-date">
                        <span class="material-icons-sharp" style="font-size: 14px;">calendar_today</span>
                        {{ bill.date|date:"M d, Y" }}
                    </div>
                </div>
                
                <div class="client-info">
                    <div class="client-name">
                        <span class="material-icons-sharp" style="font-size: 18px;">person</span>
                        {{ bill.client.full_name }}
                    </div>
                    <div class="client-details">
                        {% if bill.client.phone %}
                        <span><span class="material-icons-sharp" style="font-size: 12px;">phone</span> {{ bill.client.phone }}</span>
                        {% endif %}
                        {% if bill.client.email %}
                        <span><span class="material-icons-sharp" style="font-size: 12px;">email</span> {{ bill.client.email }}</span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="bill-summary-info">
                    <div class="items-count">
                        <span class="material-icons-sharp" style="font-size: 16px;">list</span>
                        {{ bill.items.count }} item{{ bill.items.count|pluralize }}
                    </div>
                    <div class="bill-amount">${{ bill.total_price|floatformat:2 }}</div>
                </div>
                
                <div class="bill-actions" onclick="event.stopPropagation()">
                    <button class="action-btn view" onclick="window.location.href='{% url 'core:client_detail' bill.client.lid %}'">
                        <span class="material-icons-sharp" style="font-size: 14px;">visibility</span>
                        View
                    </button>
                    <button class="action-btn print" onclick="window.open('{% url 'core:print_bill' bill.id %}', '_blank')">
                        <span class="material-icons-sharp" style="font-size: 14px;">print</span>
                        Print
                    </button>
                    <button class="action-btn duplicate" onclick="window.location.href='{% url 'core:duplicate_bill' bill.id %}'">
                        <span class="material-icons-sharp" style="font-size: 14px;">content_copy</span>
                        Copy
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-state">
            <span class="material-icons-sharp">receipt</span>
            <h3>No Bills Yet</h3>
            <p>Create your first bill using the form above</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Progress Indicator -->
<div class="progress-indicator" id="progressIndicator">
    <div class="progress-content">
        <div class="spinner"></div>
        <div class="progress-text">Saving bills...</div>
    </div>
</div>

<!-- Toast Notification -->
<div class="toast" id="toast">
    <span class="material-icons-sharp">check_circle</span>
    <span class="toast-message"></span>
</div>

<script src="{% static 'javascript/create-bill-complete.js' %}"></script>

{% endblock content %}
