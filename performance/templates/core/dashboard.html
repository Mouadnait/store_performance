{% extends 'base.html' %}
{% load static %}

{% block style-content %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<!-- Chart.js for modern charting -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- Leaflet CSS for interactive map -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
{% endblock style-content %}

{% block title %}Dashboard | Store Performance{% endblock title %}
{% block content-title %}Dashboard{% endblock content-title %}

{% block content %}
<div class="dashboard-area">
    <!-- Header Section -->
    <div class="dashboard-header">
        <div class="header-content">
            <h1>Welcome back, {{ request.user.username }}!</h1>
            <p>Here's your store performance overview</p>
        </div>
        <div class="header-date">
            <span id="current-date"></span>
        </div>
    </div>

    <!-- KPI Cards Section -->
    <div class="kpi-section">
        <div class="kpi-row">
            <!-- Total Revenue -->
            <div class="kpi-card">
                <div class="kpi-icon revenue">
                    <span class="material-icons-sharp">trending_up</span>
                </div>
                <div class="kpi-content">
                    <p class="kpi-label">Total Revenue</p>
                    <h2 class="kpi-value">${{ kpis.total_revenue|floatformat:2 }}</h2>
                    <span class="kpi-subtitle">All time</span>
                </div>
            </div>

            <!-- Today's Revenue -->
            <div class="kpi-card">
                <div class="kpi-icon today">
                    <span class="material-icons-sharp">calendar_today</span>
                </div>
                <div class="kpi-content">
                    <p class="kpi-label">Today's Revenue</p>
                    <h2 class="kpi-value">${{ kpis.today_revenue|floatformat:2 }}</h2>
                    <span class="kpi-subtitle">{{ kpis.today_bills }} bills</span>
                </div>
            </div>

            <!-- Month Revenue -->
            <div class="kpi-card">
                <div class="kpi-icon month">
                    <span class="material-icons-sharp">date_range</span>
                </div>
                <div class="kpi-content">
                    <p class="kpi-label">This Month</p>
                    <h2 class="kpi-value">${{ kpis.month_revenue|floatformat:2 }}</h2>
                    <span class="kpi-subtitle">{{ kpis.month_bills }} bills</span>
                </div>
            </div>

            <!-- Avg Bill Value -->
            <div class="kpi-card">
                <div class="kpi-icon avg">
                    <span class="material-icons-sharp">assessment</span>
                </div>
                <div class="kpi-content">
                    <p class="kpi-label">Avg Bill Value</p>
                    <h2 class="kpi-value">${{ kpis.avg_bill_value|floatformat:2 }}</h2>
                    <span class="kpi-subtitle">Per transaction</span>
                </div>
            </div>
        </div>

        <div class="kpi-row">
            <!-- Total Clients -->
            <div class="kpi-card">
                <div class="kpi-icon clients">
                    <span class="material-icons-sharp">people</span>
                </div>
                <div class="kpi-content">
                    <p class="kpi-label">Total Clients</p>
                    <h2 class="kpi-value">{{ kpis.total_clients }}</h2>
                    <span class="kpi-subtitle">Active customers</span>
                </div>
            </div>

            <!-- Total Products -->
            <div class="kpi-card">
                <div class="kpi-icon products">
                    <span class="material-icons-sharp">inventory_2</span>
                </div>
                <div class="kpi-content">
                    <p class="kpi-label">Total Products</p>
                    <h2 class="kpi-value">{{ kpis.total_products }}</h2>
                    <span class="kpi-subtitle">In inventory</span>
                </div>
            </div>

            <!-- Total Quantity -->
            <div class="kpi-card">
                <div class="kpi-icon quantity">
                    <span class="material-icons-sharp">stack</span>
                </div>
                <div class="kpi-content">
                    <p class="kpi-label">Total Quantity</p>
                    <h2 class="kpi-value">{{ kpis.total_quantity }}</h2>
                    <span class="kpi-subtitle">Items sold</span>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="kpi-card actions-card">
                <div class="quick-actions">
                    <a href="{% url 'core:products' %}#bill-builder" class="action-btn primary">
                        <span class="material-icons-sharp">add_circle</span>
                        <span>Create Bill</span>
                    </a>
                    <a href="{% url 'core:products' %}" class="action-btn secondary">
                        <span class="material-icons-sharp">add</span>
                        <span>Add Product</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
        <!-- Controls -->
        <div class="charts-controls" style="display:flex; gap:12px; margin-bottom:16px; flex-wrap:wrap;">
            {% if not show_geo %}
            <a href="{% url 'core:dashboard' %}?show_geo=1" class="action-btn secondary" style="display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border:1px solid #e5e7eb; border-radius:8px; background:#fff; text-decoration:none; color:#374151; transition:all 0.2s;">
                <span class="material-icons-sharp">map</span>
                <span>Show Geographic Distribution</span>
            </a>
            {% else %}
            <a href="{% url 'core:dashboard' %}" class="action-btn secondary" style="display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border:2px solid #7c3aed; border-radius:8px; background:#f5f3ff; text-decoration:none; color:#7c3aed; font-weight:600;">
                <span class="material-icons-sharp">visibility_off</span>
                <span>Hide Geographic Distribution</span>
            </a>
            {% endif %}
            
            {% if not debug %}
            <a href="{% url 'core:dashboard' %}?debug=1" class="action-btn secondary" style="display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border:1px solid #e5e7eb; border-radius:8px; background:#fff; text-decoration:none; color:#374151; transition:all 0.2s;">
                <span class="material-icons-sharp">speed</span>
                <span>Show Timings</span>
            </a>
            {% else %}
            <a href="{% url 'core:dashboard' %}" class="action-btn secondary" style="display:inline-flex; align-items:center; gap:8px; padding:10px 14px; border:2px solid #10b981; border-radius:8px; background:#d1fae5; text-decoration:none; color:#065f46; font-weight:600;">
                <span class="material-icons-sharp">speed</span>
                <span>Timings Active</span>
            </a>
            {% endif %}
        </div>
        <!-- Row 1: Key Performance Charts -->
        <div class="charts-row">
            {% if top_clients_chart %}
            <div class="chart-container">
                <div class="chart-header">
                    <h3>Top Clients by Revenue</h3>
                    <span class="chart-badge">Top 8</span>
                </div>
                <canvas id="topClientsChart"></canvas>
            </div>
            {% endif %}

            {% if top_products_chart %}
            <div class="chart-container">
                <div class="chart-header">
                    <h3>Top Products by Quantity</h3>
                    <span class="chart-badge">Top 8</span>
                </div>
                <canvas id="topProductsChart"></canvas>
            </div>
            {% endif %}
        </div>

        <!-- Row 2: Revenue Trend & Product Share -->
        <div class="charts-row">
            {% if line_chart %}
            <div class="chart-container">
                <div class="chart-header">
                    <h3>Revenue Trend</h3>
                    <span class="chart-subtitle">Monthly performance</span>
                </div>
                <canvas id="monthlyTrendChart"></canvas>
            </div>
            {% endif %}

            {% if pie_chart %}
            <div class="chart-container">
                <div class="chart-header">
                    <h3>Product Share</h3>
                    <span class="chart-subtitle">Sales distribution</span>
                </div>
                <canvas id="productShareChart"></canvas>
            </div>
            {% endif %}
        </div>

        <!-- Row 3: Today's Sales -->
        <div class="charts-row">
            {% if bar_chart %}
            <div class="chart-container">
                <div class="chart-header">
                    <h3>Today's Sales</h3>
                    <span class="chart-subtitle">Products sold today</span>
                </div>
                <canvas id="todaySalesChart"></canvas>
            </div>
            {% endif %}
        </div>

        <!-- Row 4: Map -->
        <div class="charts-row">
            {% if show_geo and geo_data %}
            <div class="chart-container wide">
                <div class="chart-header">
                    <h3>Geographic Distribution</h3>
                    <span class="chart-subtitle">All client locations</span>
                </div>
                <div id="client-map" style="width:100%; height:500px; border-radius:8px; border:1px solid #e5e7eb;"></div>
            </div>
            {% endif %}
        </div>

        <!-- Table: Recent Transactions -->
        {% if table_chart %}
        <div class="chart-container wide">
            <div class="chart-header">
                <h3>Recent Transactions</h3>
                <span class="chart-subtitle">Last 10 bills</span>
            </div>
            <div class="table-wrapper" style="overflow-x:auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Client</th>
                            <th>Total</th>
                            <th>Items</th>
                        </tr>
                    </thead>
                    <tbody id="recentBillsBody">
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </div>

</div>

{% if debug and timings %}
<div class="timings-panel" style="margin-top:16px; padding:12px; border:1px dashed #e5e7eb; border-radius:8px; color:#6b7280;">
    <strong>Timings (ms):</strong>
    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:8px; margin-top:8px;">
        {% for k,v in timings.items %}
        <div style="background:#f9fafb; padding:8px 10px; border-radius:6px;">
            <span style="font-weight:600;">{{ k }}</span>: {{ v }}
        </div>
        {% endfor %}
    </div>
    <div style="margin-top:8px; font-size:0.9em;">Chart.js loaded via CDN once; charts rendered client-side. Leaflet map renders client locations dynamically.</div>
</div>
{% endif %}

<!-- Leaflet JS for map rendering -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

{% endblock content %}