{% extends 'base.html' %}
{% load static %}

{% block style-content %}
    <link rel="stylesheet" href="{% static 'css/client-bills.css' %}">
    <style>
        .client-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .client-header h1 {
            margin: 0 0 10px 0;
            font-size: 2.5em;
        }
        .client-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .info-box {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
        }
        .info-box label {
            display: block;
            font-size: 0.85em;
            opacity: 0.9;
            margin-bottom: 5px;
        }
        .info-box p {
            margin: 0;
            font-weight: 600;
            font-size: 1.1em;
        }
        .bills-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .bill-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
        }
        .bill-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            border-color: #667eea;
        }
        .bill-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
            gap: 15px;
        }
        .bill-header h3 {
            margin: 0;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .bill-date {
            background: #667eea;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }
        .bill-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .bill-content {
            padding: 20px;
        }
        .bill-items {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .item-field {
            display: flex;
            flex-direction: column;
        }
        .item-field label {
            font-weight: 600;
            color: #555;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        .item-field p {
            margin: 0;
            color: #333;
            font-size: 1.1em;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .bill-total {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        .bill-total-amount {
            font-size: 2em;
            font-weight: bold;
        }
        .action-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }
        .action-btn.edit {
            background: #667eea;
            color: white;
        }
        .action-btn.delete {
            background: #ff6b6b;
            color: white;
        }
        .action-btn.print {
            background: #4CAF50;
            color: white;
        }
        .action-btn.duplicate {
            background: #FF9800;
            color: white;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        .stat-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            text-align: center;
        }
        .stat-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #333;
        }
        .controls-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            align-items: end;
            margin-top: 10px;
            margin-bottom: 16px;
        }
        .filter-field label {
            font-weight: 600;
            font-size: 0.9em;
            color: #444;
            margin-bottom: 6px;
            display: block;
        }
        .filter-field input,
        .filter-field select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 8px;
            background: #fff;
        }
        .controls-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .action-btn.btn-primary {
            background: #667eea;
            color: white;
        }
        .action-btn.btn-secondary {
            background: #eef2ff;
            color: #374151;
            border: 1px solid #cbd5ff;
        }
        .action-btn.btn-ghost {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #e5e7eb;
        }
        .hidden {
            display: none !important;
        }
        .results-meta {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: #374151;
            margin: 8px 0 16px;
        }
        .pill {
            background: #eef2ff;
            color: #4f46e5;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 0.85em;
        }
        .inline-empty {
            padding: 18px;
            background: white;
            border: 1px dashed #cbd5e1;
            border-radius: 8px;
            text-align: center;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 90%;
        }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
    </style>
{% endblock style-content %}

{% block title %}{{ client.full_name }}'s Bills | Store Performance{% endblock title %}

{% block content-title %}Client Bills{% endblock content-title %}

{% block content %}
<div class="content-area">
    <!-- Client Header -->
    <div class="client-header">
        <h1>{{ client.full_name }}</h1>
        <div class="client-info">
            {% if client.email %}
            <div class="info-box"><label>üìß Email</label><p>{{ client.email }}</p></div>
            {% endif %}
            {% if client.phone %}
            <div class="info-box"><label>üì± Phone</label><p>{{ client.phone }}</p></div>
            {% endif %}
            {% if client.address %}
            <div class="info-box"><label>üìç Address</label><p>{{ client.address }}</p></div>
            {% endif %}
        </div>
    </div>

    <!-- Statistics -->
    {% if bills %}
    <div class="controls-bar">
        <div class="filter-field">
            <label for="searchBills">Search bills</label>
            <input type="text" id="searchBills" placeholder="Search description" autocomplete="off">
        </div>
        <div class="filter-field">
            <label for="startDate">Start date</label>
            <input type="date" id="startDate">
        </div>
        <div class="filter-field">
            <label for="endDate">End date</label>
            <input type="date" id="endDate">
        </div>
        <div class="filter-field">
            <label for="sortBills">Sort by</label>
            <select id="sortBills">
                <option value="newest">Date: Newest first</option>
                <option value="oldest">Date: Oldest first</option>
                <option value="total_high">Total: High to low</option>
                <option value="total_low">Total: Low to high</option>
            </select>
        </div>
        <div class="controls-actions">
            <button type="button" class="action-btn btn-secondary" id="clearFilters">Clear filters</button>
            <a class="action-btn btn-primary" href="{% url 'core:create-bill' %}">+ New bill</a>
        </div>
    </div>
    <div class="results-meta">
        <span id="resultsCount">Showing {{ bills|length }} bills</span>
        <span class="pill" id="filterState">No filters</span>
    </div>
    <div class="stats-grid">
        <div class="stat-item">
            <div>Total Bills</div>
            <div class="stat-value">{{ bills|length }}</div>
        </div>
        <div class="stat-item">
            <div>Total Revenue</div>
            <div class="stat-value" style="color: #4CAF50;">${{ total_revenue|floatformat:2 }}</div>
        </div>
        <div class="stat-item">
            <div>Total Quantity</div>
            <div class="stat-value">{{ total_quantity }}</div>
        </div>
        <div class="stat-item">
            <div>Avg Bill</div>
            <div class="stat-value" style="color: #667eea;">${{ avg_bill|floatformat:2 }}</div>
        </div>
    </div>
    {% endif %}

    <!-- Bills List -->
    {% if bills %}
    <div class="bills-container" style="margin-top: 30px;">
        {% for bill in bills %}
        <div class="bill-card" data-description="{{ bill.description|lower|escape }}" data-date="{{ bill.date|date:'Y-m-d' }}" data-total="{{ bill.total_price }}">
            <div class="bill-header">
                <h3><span class="material-icons-sharp" style="color: #667eea;">receipt</span>Bill #{{ bill.id }}</h3>
                <div class="bill-date">{{ bill.date|date:"M d, Y" }}</div>
                <div class="bill-actions">
                    <button class="action-btn edit" onclick="openEditModal({{ bill.id }}, '{{ bill.description|escapejs }}', {{ bill.quantity }}, {{ bill.price }}, {{ bill.amount }}, {{ bill.total_price }})">
                        <span class="material-icons-sharp">edit</span>Edit
                    </button>
                    <button class="action-btn print" onclick="printBill({{ bill.id }})">
                        <span class="material-icons-sharp">print</span>Print
                    </button>
                    <button class="action-btn duplicate" onclick="duplicateBill({{ bill.id }})">
                        <span class="material-icons-sharp">content_copy</span>Duplicate
                    </button>
                    <button class="action-btn delete" onclick="deleteBill({{ bill.id }})">
                        <span class="material-icons-sharp">delete</span>Delete
                    </button>
                </div>
            </div>
            <div class="bill-content">
                <div class="bill-items">
                    <div class="item-field"><label>Product/Service</label><p>{{ bill.description }}</p></div>
                    <div class="item-field"><label>Quantity</label><p>{{ bill.quantity }} units</p></div>
                    <div class="item-field"><label>Unit Price</label><p>${{ bill.price|floatformat:2 }}</p></div>
                    <div class="item-field"><label>Amount</label><p>${{ bill.amount|floatformat:2 }}</p></div>
                </div>
                <div class="bill-total">
                    <div><div style="font-size: 0.9em;">Total</div><div class="bill-total-amount">${{ bill.total_price|floatformat:2 }}</div></div>
                    <div style="text-align: right; font-size: 0.9em;"><div>{{ bill.store_name }}</div></div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    <div id="filteredEmpty" class="inline-empty hidden">No bills match these filters.</div>
    {% else %}
    <div style="text-align: center; padding: 60px 20px; background: white; border-radius: 10px;">
        <h3>üìã No Bills Yet</h3>
        <p>Create your first bill for this client</p>
        <a href="{% url 'core:products' %}" style="background: #667eea; color: white; padding: 12px 30px; border-radius: 6px; text-decoration: none; display: inline-block; font-weight: 600;">Create Bill</a>
    </div>
    {% endif %}
</div>

<!-- Edit Bill Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
            <h2 style="margin: 0;">Edit Bill</h2>
            <button type="button" style="background: none; border: none; font-size: 28px; cursor: pointer;" onclick="closeEditModal()">&times;</button>
        </div>
        <form id="editForm" method="POST">
            {% csrf_token %}
            <input type="hidden" id="billId" name="bill_id">
            <div class="form-group"><label>Description</label><textarea id="editDescription" name="description" rows="3" required></textarea></div>
            <div class="form-group"><label>Quantity</label><input type="number" id="editQuantity" name="quantity" step="0.01" required></div>
            <div class="form-group"><label>Unit Price</label><input type="number" id="editPrice" name="price" step="0.01" required></div>
            <div class="form-group"><label>Amount</label><input type="number" id="editAmount" name="amount" readonly></div>
            <div class="form-group"><label>Total</label><input type="number" id="editTotal" name="total_price" required></div>
            <div class="form-actions">
                <button type="button" style="background: #ddd; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;" onclick="closeEditModal()">Cancel</button>
                <button type="submit" style="background: #667eea; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">Save</button>
            </div>
        </form>
    </div>
</div>

<script>
function openEditModal(billId, desc, qty, price, amount, total) {
    document.getElementById('billId').value = billId;
    document.getElementById('editDescription').value = desc;
    document.getElementById('editQuantity').value = qty;
    document.getElementById('editPrice').value = price;
    document.getElementById('editAmount').value = parseFloat(amount).toFixed(2);
    document.getElementById('editTotal').value = parseFloat(total).toFixed(2);
    document.getElementById('editModal').classList.add('show');
}
function closeEditModal() {
    document.getElementById('editModal').classList.remove('show');
}
document.getElementById('editQuantity')?.addEventListener('input', calcAmount);
document.getElementById('editPrice')?.addEventListener('input', calcAmount);
function calcAmount() {
    const qty = parseFloat(document.getElementById('editQuantity').value) || 0;
    const price = parseFloat(document.getElementById('editPrice').value) || 0;
    const amount = qty * price;
    document.getElementById('editAmount').value = amount.toFixed(2);
    document.getElementById('editTotal').value = amount.toFixed(2);
}
document.getElementById('editForm')?.addEventListener('submit', function(e) {
    this.action = `/core/bill/${document.getElementById('billId').value}/edit/`;
});
function deleteBill(billId) {
    if (confirm('Delete this bill?')) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/core/bill/${billId}/delete/`;
        const token = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        if (token) {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'csrfmiddlewaretoken';
            input.value = token;
            form.appendChild(input);
        }
        document.body.appendChild(form);
        form.submit();
    }
}
function printBill(billId) {
    window.location.href = `/core/bill/${billId}/print/`;
}
function duplicateBill(billId) {
    if (confirm('Duplicate this bill?')) {
        window.location.href = `/core/bill/${billId}/duplicate/`;
    }
}
window.addEventListener('click', function(e) {
    if (e.target === document.getElementById('editModal')) closeEditModal();
});

// Client-side filtering and sorting for quick triage
const cards = Array.from(document.querySelectorAll('.bill-card'));
const searchInput = document.getElementById('searchBills');
const startInput = document.getElementById('startDate');
const endInput = document.getElementById('endDate');
const sortSelect = document.getElementById('sortBills');
const resultsCount = document.getElementById('resultsCount');
const filterState = document.getElementById('filterState');
const filteredEmpty = document.getElementById('filteredEmpty');

function filterAndSortBills() {
    const term = (searchInput?.value || '').toLowerCase().trim();
    const start = startInput?.value ? new Date(startInput.value) : null;
    const end = endInput?.value ? new Date(endInput.value) : null;
    let visibleCards = [];

    cards.forEach(card => {
        const desc = (card.dataset.description || '').toLowerCase();
        const dateStr = card.dataset.date;
        const total = parseFloat(card.dataset.total || '0');
        const date = dateStr ? new Date(dateStr) : null;

        let isVisible = true;
        if (term && !desc.includes(term)) isVisible = false;
        if (start && date && date < start) isVisible = false;
        if (end && date && date > end) isVisible = false;

        card.classList.toggle('hidden', !isVisible);
        if (isVisible) visibleCards.push({ card, date, total });
    });

    const sortMode = sortSelect?.value || 'newest';
    const sorters = {
        newest: (a, b) => (b.date || 0) - (a.date || 0),
        oldest: (a, b) => (a.date || 0) - (b.date || 0),
        total_high: (a, b) => (b.total || 0) - (a.total || 0),
        total_low: (a, b) => (a.total || 0) - (b.total || 0),
    };
    visibleCards.sort(sorters[sortMode] || sorters.newest);
    visibleCards.forEach((item, idx) => {
        item.card.style.order = idx;
    });

    const count = visibleCards.length;
    if (resultsCount) {
        resultsCount.textContent = `Showing ${count} bill${count === 1 ? '' : 's'}`;
    }
    if (filterState) {
        const active = [];
        if (term) active.push(`Search: ${term}`);
        if (start) active.push(`From ${startInput.value}`);
        if (end) active.push(`To ${endInput.value}`);
        filterState.textContent = active.length ? active.join(' | ') : 'No filters';
    }
    if (filteredEmpty) {
        filteredEmpty.classList.toggle('hidden', count !== 0);
    }
}

searchInput?.addEventListener('input', filterAndSortBills);
startInput?.addEventListener('change', filterAndSortBills);
endInput?.addEventListener('change', filterAndSortBills);
sortSelect?.addEventListener('change', filterAndSortBills);
document.getElementById('clearFilters')?.addEventListener('click', () => {
    if (searchInput) searchInput.value = '';
    if (startInput) startInput.value = '';
    if (endInput) endInput.value = '';
    if (sortSelect) sortSelect.value = 'newest';
    filterAndSortBills();
});

filterAndSortBills();
</script>
{% endblock content %}
