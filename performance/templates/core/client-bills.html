{% extends 'base.html' %}
{% load static %}

{% block style-content %}
    <link rel="stylesheet" href="{% static 'css/client-bills.css' %}?v=2.0">
    <script src="{% static 'javascript/client-bills.js' %}?v=3.0"></script>
    <script src="{% static 'javascript/bill-editor.js' %}?v=1.0"></script>
{% endblock style-content %}

{% block title %}{{ client.full_name }}'s Bills | Store Performance{% endblock title %}

{% block content-title %}Client Bills{% endblock content-title %}

{% block content %}
<div class="content-area">
    <!-- Hidden CSRF token for JavaScript forms -->
    {% csrf_token %}
    
    <!-- Client Header -->
    <div class="client-header">
        <div style="display:flex; align-items:center; gap:20px; margin-bottom:20px;">
            <div style="position:relative;">
                <div style="width:100px; height:100px; border-radius:50%; overflow:hidden; border:3px solid #667eea;">
                    {% if client.profile_image and client.profile_image.url %}
                    <img src="{{ client.profile_image.url }}" alt="{{ client.full_name }}" style="width:100%; height:100%; object-fit:cover;">
                    {% else %}
                    <div style="width:100%; height:100%; background:#667eea; color:white; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:2em;">{{ client.full_name|slice:":1"|upper }}</div>
                    {% endif %}
                </div>
                <button type="button" onclick="openUpdatePictureModal('{{ client.lid }}')" style="position:absolute; bottom:0; right:0; background:#667eea; color:white; border:none; border-radius:50%; width:36px; height:36px; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:18px; box-shadow:0 2px 8px rgba(0,0,0,0.15);" title="Update picture">
                    <span class="material-icons-sharp">edit</span>
                </button>
            </div>
            <div>
                <h1>{{ client.full_name }}</h1>
                <div class="client-info">
                    {% if client.email %}
                    <div class="info-box"><label>üìß Email</label><p>{{ client.email }}</p></div>
                    {% endif %}
                    {% if client.phone %}
                    <div class="info-box"><label>üì± Phone</label><p>{{ client.phone }}</p></div>
                    {% endif %}
                    {% if client.address %}
                    <div class="info-box"><label>üìç Address</label><p>{{ client.address }}</p></div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics -->
    {% if bills %}
    <div class="filters-panel">
        <div class="controls-bar">
            <div class="filter-field">
                <label for="searchBills">Search bills</label>
                <input type="text" id="searchBills" placeholder="Search description" autocomplete="off">
            </div>
            <div class="filter-field">
                <label for="startDate">Start date</label>
                <input type="date" id="startDate">
            </div>
            <div class="filter-field">
                <label for="endDate">End date</label>
                <input type="date" id="endDate">
            </div>
            <div class="filter-field">
                <label for="sortBills">Sort by</label>
                <select id="sortBills">
                    <option value="newest">Date: Newest first</option>
                    <option value="oldest">Date: Oldest first</option>
                    <option value="total_high">Total: High to low</option>
                    <option value="total_low">Total: Low to high</option>
                </select>
            </div>
            <div class="controls-actions">
                <button type="button" class="action-btn btn-secondary" id="clearFilters">Clear filters</button>
                <a class="action-btn btn-primary" href="{% url 'core:create-bill' %}">+ New bill</a>
            </div>
        </div>
        <div class="results-meta">
            <span id="resultsCount">Showing {{ bills|length }} bills</span>
            <span class="pill" id="filterState">No filters</span>
        </div>
    </div>
    <div class="stats-grid">
        <div class="stat-item">
            <div class="stat-label">Total Bills</div>
            <div class="stat-value">{{ bills|length }}</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">Total Revenue</div>
            <div class="stat-value" style="color: #4CAF50;">${{ total_revenue|floatformat:2 }}</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">Total Quantity</div>
            <div class="stat-value">{{ total_quantity|floatformat:0 }}</div>
        </div>
        <div class="stat-item">
            <div class="stat-label">Average Bill</div>
            <div class="stat-value" style="color: #667eea;">${{ avg_bill|floatformat:2 }}</div>
        </div>
    </div>
    {% endif %}

    <!-- Bills List -->
    {% if bills %}
    <div class="bills-container" style="margin-top: 30px;">
        {% for bill in bills %}
        <div class="bill-card" data-description="{{ bill.description|lower|escape }}" data-date="{{ bill.date|date:'Y-m-d' }}" data-total="{{ bill.total_price }}">
            <div class="bill-header" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:20px; display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0; display:flex; align-items:center; gap:10px; font-size:1.3em;"><span class="material-icons-sharp" style="font-size:28px;">receipt</span>Bill #{{ bill.id }}</h3>
                <div class="bill-date" style="background:rgba(255,255,255,0.2); padding:8px 16px; border-radius:6px; font-weight:500;">{{ bill.date|date:"M d, Y" }}</div>
            </div>
            <div class="bill-content" style="padding:20px;">
                <div class="bill-items">
                    {% if bill.items.all %}
                    <table class="bill-items-table" style="width:100%; border-collapse:collapse; margin:10px 0;">
                        <thead>
                            <tr style="background:#f8f9fa; border-bottom:2px solid #dee2e6;">
                                <th style="text-align:left; padding:12px 8px; font-weight:600; color:#495057; text-transform:uppercase; font-size:0.85em;">Item</th>
                                <th style="text-align:right; padding:12px 8px; font-weight:600; color:#495057; text-transform:uppercase; font-size:0.85em;">Qty</th>
                                <th style="text-align:right; padding:12px 8px; font-weight:600; color:#495057; text-transform:uppercase; font-size:0.85em;">Unit Price</th>
                                <th style="text-align:right; padding:12px 8px; font-weight:600; color:#495057; text-transform:uppercase; font-size:0.85em;">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in bill.items.all %}
                            <tr style="border-bottom:1px solid #e9ecef;">
                                <td title="{{ item.description }}" style="padding:12px 8px; max-width:300px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; font-weight:500;">{{ item.description }}</td>
                                <td style="text-align:right; padding:12px 8px;">{{ item.quantity|floatformat:2 }}</td>
                                <td style="text-align:right; padding:12px 8px;">${{ item.price|floatformat:2 }}</td>
                                <td style="text-align:right; padding:12px 8px; font-weight:600;">${{ item.amount|floatformat:2 }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <!-- Legacy bill format (single item stored in Bill model fields) -->
                    <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:15px;">
                        <div class="item-field">
                            <label>Product/Service</label>
                            <p title="{{ bill.description }}">{% if bill.description %}{{ bill.description }}{% else %}<em style="color: #999;">Not specified</em>{% endif %}</p>
                        </div>
                        <div class="item-field">
                            <label>Quantity</label>
                            <p>{% if bill.quantity %}{{ bill.quantity|floatformat:2 }} units{% else %}<em style="color: #999;">0 units</em>{% endif %}</p>
                        </div>
                        <div class="item-field">
                            <label>Unit Price</label>
                            <p>{% if bill.price %}${{ bill.price|floatformat:2 }}{% else %}<em style="color: #999;">$0.00</em>{% endif %}</p>
                        </div>
                        <div class="item-field">
                            <label>Subtotal</label>
                            <p>{% if bill.amount %}${{ bill.amount|floatformat:2 }}{% else %}<em style="color: #999;">$0.00</em>{% endif %}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="bill-total" style="display:flex; justify-content:space-between; align-items:center; margin-top:20px; padding-top:20px; border-top:3px solid #667eea; background:#f8f9fa; padding:20px; border-radius:8px;">
                    <div>
                        <div style="font-size: 0.9em; opacity: 0.7; color:#495057; font-weight:600;">GRAND TOTAL</div>
                        <div class="bill-total-amount" style="font-size:2.2em; font-weight:700; color:#667eea;">${{ bill.total_price|floatformat:2 }}</div>
                        {% if bill.items.all %}
                        <div style="font-size: 0.9em; opacity: 0.7; color:#6c757d; margin-top:5px;">{{ bill.total_quantity|floatformat:0 }} units total</div>
                        {% endif %}
                    </div>
                    <div style="text-align: right; font-size: 0.9em; color:#6c757d;">
                        <div style="display:flex; align-items:center; gap:6px; justify-content:flex-end;"><span class="material-icons-sharp" style="font-size:16px;">store</span>{{ bill.store_name.username }}</div>
                        <div style="display:flex; align-items:center; gap:6px; justify-content:flex-end; margin-top:4px;"><span class="material-icons-sharp" style="font-size:16px;">calendar_today</span>{{ bill.date|date:"M d, Y" }}</div>
                    </div>
                </div>
                <div class="bill-actions" style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb; display:flex; gap:10px; flex-wrap:wrap;">
                    <button class="action-btn edit" onclick="openBillEditor({{ bill.id }})" style="background:#667eea; color:white; border:none; padding:10px 16px; border-radius:6px; cursor:pointer; display:flex; align-items:center; gap:6px; font-weight:500; transition:background 0.2s;">
                        <span class="material-icons-sharp" style="font-size:18px;">edit</span>Edit Bill
                    </button>
                    <button class="action-btn print" onclick="printBill({{ bill.id }})" style="background:#10b981; color:white; border:none; padding:10px 16px; border-radius:6px; cursor:pointer; display:flex; align-items:center; gap:6px; font-weight:500; transition:background 0.2s;">
                        <span class="material-icons-sharp" style="font-size:18px;">print</span>Print
                    </button>
                    <button class="action-btn duplicate" onclick="duplicateBill({{ bill.id }})" style="background:#f59e0b; color:white; border:none; padding:10px 16px; border-radius:6px; cursor:pointer; display:flex; align-items:center; gap:6px; font-weight:500; transition:background 0.2s;">
                        <span class="material-icons-sharp" style="font-size:18px;">content_copy</span>Copy
                    </button>
                    <button class="action-btn delete" onclick="deleteBill({{ bill.id }})" style="background:#ef4444; color:white; border:none; padding:10px 16px; border-radius:6px; cursor:pointer; display:flex; align-items:center; gap:6px; font-weight:500; transition:background 0.2s;">
                        <span class="material-icons-sharp" style="font-size:18px;">delete</span>Delete
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    <div id="filteredEmpty" class="inline-empty hidden">No bills match these filters.</div>
    {% else %}
    <div class="empty-state">
        <h3>üìã No Bills Yet</h3>
        <p>Create your first bill for this client</p>
        <a href="{% url 'core:products' %}" class="action-btn btn-primary">
            <span class="material-icons-sharp">add_circle</span>
            Create Bill
        </a>
    </div>
    {% endif %}
</div>

<!-- Edit Bill Modal -->
<div id="editModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; overflow-y:auto;">
    <div class="modal-content" style="background:white; max-width:1000px; margin:40px auto; border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,0.2); max-height:90vh; overflow:hidden; display:flex; flex-direction:column;">
        <div class="modal-header" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:white; padding:24px 28px; display:flex; justify-content:space-between; align-items:center; border-radius:12px 12px 0 0;">
            <div>
                <h2 style="margin:0; font-size:1.6em; display:flex; align-items:center; gap:10px;"><span class="material-icons-sharp" style="font-size:32px;">edit_note</span>Edit Bill</h2>
                <p style="margin:8px 0 0 0; opacity:0.9; font-size:0.95em;">Manage items, add products, and update bill details</p>
            </div>
            <button type="button" class="modal-close" onclick="closeEditModal()" style="background:rgba(255,255,255,0.2); border:none; color:white; font-size:28px; width:40px; height:40px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:background 0.2s;">&times;</button>
        </div>
        
        <div style="flex:1; overflow-y:auto; padding:28px;">
            <!-- Bill Info -->
            <div style="background:#f8f9fa; padding:16px 20px; border-radius:8px; margin-bottom:24px; display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px;">
                <div>
                    <div style="font-size:0.85em; color:#6c757d; font-weight:600; margin-bottom:4px;">BILL ID</div>
                    <div style="font-size:1.1em; font-weight:700; color:#495057;" id="editBillId">#0</div>
                </div>
                <div>
                    <div style="font-size:0.85em; color:#6c757d; font-weight:600; margin-bottom:4px;">CLIENT</div>
                    <div style="font-size:1.1em; font-weight:700; color:#495057;" id="editClientName">-</div>
                </div>
                <div>
                    <div style="font-size:0.85em; color:#6c757d; font-weight:600; margin-bottom:4px;">DATE</div>
                    <div style="font-size:1.1em; font-weight:700; color:#495057;" id="editBillDate">-</div>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div style="display:flex; gap:12px; border-bottom:2px solid #e9ecef; margin-bottom:24px;">
                <button class="tab-btn active" onclick="switchTab('items')" data-tab="items" style="background:none; border:none; padding:12px 24px; font-weight:600; color:#6c757d; cursor:pointer; border-bottom:3px solid transparent; transition:all 0.2s;">
                    <span class="material-icons-sharp" style="font-size:18px; vertical-align:middle; margin-right:6px;">list</span>Current Items
                </button>
                <button class="tab-btn" onclick="switchTab('add')" data-tab="add" style="background:none; border:none; padding:12px 24px; font-weight:600; color:#6c757d; cursor:pointer; border-bottom:3px solid transparent; transition:all 0.2s;">
                    <span class="material-icons-sharp" style="font-size:18px; vertical-align:middle; margin-right:6px;">add_shopping_cart</span>Add Products
                </button>
            </div>

            <!-- Current Items Tab -->
            <div id="itemsTab" class="tab-content">
                <div style="background:#fff; border:1px solid #e9ecef; border-radius:8px; overflow:hidden; margin-bottom:20px;">
                    <table style="width:100%; border-collapse:collapse;" id="editItemsTable">
                        <thead>
                            <tr style="background:#f8f9fa;">
                                <th style="padding:14px 12px; text-align:left; font-weight:600; color:#495057; text-transform:uppercase; font-size:0.85em;">Item</th>
                                <th style="padding:14px 12px; text-align:right; font-weight:600; color:#495057; text-transform:uppercase; font-size:0.85em; width:120px;">Quantity</th>
                                <th style="padding:14px 12px; text-align:right; font-weight:600; color:#495057; text-transform:uppercase; font-size:0.85em; width:140px;">Unit Price</th>
                                <th style="padding:14px 12px; text-align:right; font-weight:600; color:#495057; text-transform:uppercase; font-size:0.85em; width:140px;">Amount</th>
                                <th style="padding:14px 12px; text-align:center; font-weight:600; color:#495057; text-transform:uppercase; font-size:0.85em; width:80px;">Action</th>
                            </tr>
                        </thead>
                        <tbody id="editItemsBody">
                            <!-- Items will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Total Display -->
                <div style="background:#f8f9fa; padding:20px; border-radius:8px; display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-size:1.2em; font-weight:600; color:#495057;">TOTAL:</div>
                    <div style="font-size:2em; font-weight:700; color:#667eea;" id="editTotalDisplay">$0.00</div>
                </div>
            </div>

            <!-- Add Products Tab -->
            <div id="addTab" class="tab-content" style="display:none;">
                <div style="margin-bottom:20px;">
                    <input type="text" id="productSearch" placeholder="Search products by name..." style="width:100%; padding:12px 16px; border:2px solid #e9ecef; border-radius:8px; font-size:1em; transition:border-color 0.2s;" oninput="filterAvailableProducts()">
                </div>
                
                <div id="availableProductsList" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:16px; max-height:400px; overflow-y:auto; padding:4px;">
                    <!-- Products will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Modal Footer -->
        <div style="padding:20px 28px; background:#f8f9fa; border-top:1px solid #e9ecef; display:flex; justify-content:space-between; align-items:center; border-radius:0 0 12px 12px;">
            <button type="button" onclick="closeEditModal()" style="background:#6c757d; color:white; border:none; padding:12px 28px; border-radius:6px; cursor:pointer; font-weight:600; transition:background 0.2s;">Cancel</button>
            <button type="button" onclick="saveBillChanges()" style="background:#667eea; color:white; border:none; padding:12px 28px; border-radius:6px; cursor:pointer; font-weight:600; transition:background 0.2s; display:flex; align-items:center; gap:8px;">
                <span class="material-icons-sharp" style="font-size:20px;">save</span>Save Changes
            </button>
        </div>
    </div>
</div>

<style>
.tab-btn.active {
    color: #667eea !important;
    border-bottom-color: #667eea !important;
}
.tab-btn:hover {
    background: #f8f9fa;
}
.product-card-mini {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 8px;
    padding: 16px;
    cursor: pointer;
    transition: all 0.2s;
}
.product-card-mini:hover {
    border-color: #667eea;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
    transform: translateY(-2px);
}
.product-card-mini img {
    width: 100%;
    height: 120px;
    object-fit: cover;
    border-radius: 6px;
    margin-bottom: 12px;
}
.product-card-mini h4 {
    margin: 0 0 8px 0;
    font-size: 1em;
    color: #212529;
    font-weight: 600;
}
.product-card-mini .price {
    font-size: 1.2em;
    font-weight: 700;
    color: #667eea;
    margin-bottom: 12px;
}
.product-card-mini button {
    width: 100%;
    background: #667eea;
    color: white;
    border: none;
    padding: 10px;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
}
.product-card-mini button:hover {
    background: #5568d3;
}
</style>

<!-- Update Client Picture Modal -->
<div id="updatePictureModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; overflow-y:auto;">
    <div class="modal-content" style="background:white; max-width:500px; margin:60px auto; border-radius:12px; box-shadow:0 10px 40px rgba(0,0,0,0.2); padding:32px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
            <h2 style="margin:0; font-size:1.6em; color:#1f2937;">Update Client Picture</h2>
            <button type="button" onclick="closeUpdatePictureModal()" style="background:none; border:none; font-size:28px; color:#6b7280; cursor:pointer;">&times;</button>
        </div>
        
        <form id="updatePictureForm" enctype="multipart/form-data" style="display:flex; flex-direction:column; gap:16px;">
            {% csrf_token %}
            <input type="hidden" id="clientLidInput" name="client_lid" value="">
            
            <div style="text-align:center; padding:24px; border:2px dashed #e5e7eb; border-radius:8px; cursor:pointer;" onclick="document.getElementById('profileImageInput').click();">
                <div id="imagePreview" style="width:120px; height:120px; margin:0 auto 12px; border-radius:50%; overflow:hidden; border:2px solid #667eea; display:none;">
                    <img id="previewImg" src="" alt="Preview" style="width:100%; height:100%; object-fit:cover;">
                </div>
                <span class="material-icons-sharp" id="uploadIcon" style="font-size:40px; color:#667eea; display:block;">cloud_upload</span>
                <p style="color:#6b7280; margin:8px 0 0 0;">Click to upload or drag a file</p>
                <p style="color:#9ca3af; font-size:0.85em;">PNG, JPG up to 5MB</p>
            </div>
            
            <input type="file" id="profileImageInput" name="profile_image" accept="image/*" style="display:none;" onchange="previewImage(event)">
            
            <div style="display:flex; gap:12px; justify-content:flex-end;">
                <button type="button" onclick="closeUpdatePictureModal()" style="padding:10px 20px; border:1px solid #e5e7eb; border-radius:8px; background:white; color:#495057; font-weight:600; cursor:pointer;">Cancel</button>
                <button type="button" onclick="submitUpdatePicture()" style="padding:10px 20px; border:none; border-radius:8px; background:#667eea; color:white; font-weight:600; cursor:pointer;">Update Picture</button>
            </div>
        </form>
    </div>
</div>

{% endblock content %}

{% block scripts %}
<script>
function openUpdatePictureModal(clientLid) {
    document.getElementById('clientLidInput').value = clientLid;
    document.getElementById('updatePictureModal').style.display = 'block';
}

function closeUpdatePictureModal() {
    document.getElementById('updatePictureModal').style.display = 'none';
    document.getElementById('profileImageInput').value = '';
    document.getElementById('imagePreview').style.display = 'none';
    document.getElementById('uploadIcon').style.display = 'block';
}

function previewImage(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('imagePreview');
            const previewImg = document.getElementById('previewImg');
            const uploadIcon = document.getElementById('uploadIcon');
            previewImg.src = e.target.result;
            preview.style.display = 'block';
            uploadIcon.style.display = 'none';
        };
        reader.readAsDataURL(file);
    }
}

function submitUpdatePicture() {
    const fileInput = document.getElementById('profileImageInput');
    const clientLid = document.getElementById('clientLidInput').value;
    
    if (!fileInput.files[0]) {
        alert('Please select an image');
        return;
    }
    
    const formData = new FormData();
    formData.append('profile_image', fileInput.files[0]);
    formData.append('client_lid', clientLid);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch('/update-client-picture/', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Picture updated successfully!');
            closeUpdatePictureModal();
            location.reload(); // Reload to show updated picture
        } else {
            alert('Error: ' + (data.error || 'Failed to update picture'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating picture');
    });
}
</script>
{% endblock scripts %}
