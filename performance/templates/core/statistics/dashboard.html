{% extends 'base/base.html' %}
{% load static %}
<!-- django-template -->
{% block style-content %}
<!-- Dashboard consolidated CSS (design-system + components + dashboard) -->
<link rel="stylesheet" href="{% static 'css/statistics/dashboard.css' %}?v=1.4">
<!-- Chart.js for modern charting -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- Leaflet CSS for interactive map -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
{% endblock style-content %}

{% block title %}Dashboard | Store Performance{% endblock title %}
{% block page_title %}Dashboard{% endblock page_title %}

{% block content %}
<div class="dashboard-area">
    <!-- Header Section -->
    <div class="dashboard-header">
        <div class="header-content">
            <h1>Welcome back, {{ request.user.username }}!</h1>
            <p>Here's your store performance overview</p>
        </div>
        <div class="header-actions">
            <div class="header-chips">
                <span class="header-chip">
                    <i class="material-icons-sharp">receipt_long</i>
                    <span>{{ kpis.today_bills|default:"0" }} bills today</span>
                </span>
                <span class="header-chip">
                    <i class="material-icons-sharp">calendar_month</i>
                    <span>{{ kpis.month_bills|default:"0" }} bills this month</span>
                </span>
                <span class="header-chip">
                    <i class="material-icons-sharp">group</i>
                    <span>{{ kpis.total_clients|default:"0" }} clients</span>
                </span>
            </div>
            <div class="header-buttons">
                <a href="{% url 'core:reports' %}" class="action-btn secondary">
                    <span class="material-icons-sharp">insights</span>
                    <span>View Reports</span>
                </a>
                <a href="{% url 'core:analytics' %}" class="action-btn primary">
                    <span class="material-icons-sharp">query_stats</span>
                    <span>Open Analytics</span>
                </a>
            </div>
        </div>
        <div class="header-date">
            <span id="current-date"></span>
        </div>
    </div>

    <!-- KPI Cards Section -->
    <div class="kpi-section">
        <div class="kpi-row kpi-grid">
            <!-- Total Revenue -->
            <div class="kpi-card">
                <div class="kpi-icon revenue">
                    <span class="material-icons-sharp">trending_up</span>
                </div>
                <div class="kpi-content">
                    <p class="kpi-label">Total Revenue</p>
                    <h2 class="kpi-value">${{ kpis.total_revenue|floatformat:2 }}</h2>
                    <span class="kpi-subtitle">All time</span>
                </div>
            </div>

            <!-- Today's Revenue -->
            <div class="kpi-card">
                <div class="kpi-icon today">
                    <span class="material-icons-sharp">calendar_today</span>
                </div>
                <div class="kpi-content">
                    <p class="kpi-label">Today's Revenue</p>
                    <h2 class="kpi-value">${{ kpis.today_revenue|floatformat:2 }}</h2>
                    <span class="kpi-subtitle">{{ kpis.today_bills }} bills</span>
                </div>
            </div>

            <!-- Month Revenue -->
            <div class="kpi-card">
                <div class="kpi-icon month">
                    <span class="material-icons-sharp">date_range</span>
                </div>
                <div class="kpi-content">
                    <p class="kpi-label">This Month</p>
                    <h2 class="kpi-value">${{ kpis.month_revenue|floatformat:2 }}</h2>
                    <span class="kpi-subtitle">{{ kpis.month_bills }} bills</span>
                </div>
            </div>

            <!-- Avg Bill Value -->
            <div class="kpi-card">
                <div class="kpi-icon avg">
                    <span class="material-icons-sharp">assessment</span>
                </div>
                <div class="kpi-content">
                    <p class="kpi-label">Avg Bill Value</p>
                    <h2 class="kpi-value">${{ kpis.avg_bill_value|floatformat:2 }}</h2>
                    <span class="kpi-subtitle">Per transaction</span>
                </div>
            </div>
        </div>

        <div class="kpi-row kpi-grid">
            <!-- Total Clients -->
            <div class="kpi-card">
                <div class="kpi-icon clients">
                    <span class="material-icons-sharp">people</span>
                </div>
                <div class="kpi-content">
                    <p class="kpi-label">Total Clients</p>
                    <h2 class="kpi-value">{{ kpis.total_clients }}</h2>
                    <span class="kpi-subtitle">Active customers</span>
                </div>
            </div>

            <!-- Total Products -->
            <div class="kpi-card">
                <div class="kpi-icon products">
                    <span class="material-icons-sharp">inventory_2</span>
                </div>
                <div class="kpi-content">
                    <p class="kpi-label">Total Products</p>
                    <h2 class="kpi-value">{{ kpis.total_products }}</h2>
                    <span class="kpi-subtitle">In inventory</span>
                </div>
            </div>

            <!-- Total Quantity -->
            <div class="kpi-card">
                <div class="kpi-icon quantity">
                    <span class="material-icons-sharp">stack</span>
                </div>
                <div class="kpi-content">
                    <p class="kpi-label">Total Quantity</p>
                    <h2 class="kpi-value">{{ kpis.total_quantity }}</h2>
                    <span class="kpi-subtitle">Items sold</span>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="kpi-card actions-card">
                <div class="quick-actions">
                    <a href="{% url 'core:products' %}#bill-builder" class="action-btn primary">
                        <span class="material-icons-sharp">add_circle</span>
                        <span>Create Bill</span>
                    </a>
                    <a href="{% url 'core:products' %}" class="action-btn secondary">
                        <span class="material-icons-sharp">add</span>
                        <span>Add Product</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-row chart-grid">
        <!-- Controls -->
        <div class="chart-container chart-card">
            <div class="chart-header">
                <h3>Controls</h3>
            </div>
            <div class="chart-actions" style="gap:12px; flex-wrap: wrap;">
                {% if not show_geo %}
                <a href="{% url 'core:dashboard' %}?show_geo=1" class="action-btn secondary control-btn">
                    <span class="material-icons-sharp">map</span>
                    <span>Show Geographic Distribution</span>
                </a>
                {% else %}
                <a href="{% url 'core:dashboard' %}" class="action-btn secondary control-btn is-active">
                    <span class="material-icons-sharp">visibility_off</span>
                    <span>Hide Geographic Distribution</span>
                </a>
                {% endif %}

                {% if not debug %}
                <a href="{% url 'core:dashboard' %}?debug=1" class="action-btn secondary control-btn">
                    <span class="material-icons-sharp">speed</span>
                    <span>Show Timings</span>
                </a>
                {% else %}
                <a href="{% url 'core:dashboard' %}" class="action-btn secondary control-btn is-active-success">
                    <span class="material-icons-sharp">speed</span>
                    <span>Timings Active</span>
                </a>
                {% endif %}
            </div>
        </div>
        <!-- Row 1: Key Performance Charts -->
    </div>
    <div class="charts-row chart-grid">
            {% if top_clients_chart %}
            <div class="chart-container table-card">
                <div class="chart-header">
                    <h3>Top Clients by Revenue</h3>
                    <span class="chart-badge">Top 8</span>
                </div>
                <canvas id="topClientsChart"></canvas>
            </div>
            {% endif %}

            {% if top_products_chart %}
            <div class="chart-container table-card">
                <div class="chart-header">
                    <h3>Top Products by Quantity</h3>
                    <span class="chart-badge">Top 8</span>
                </div>
                <canvas id="topProductsChart"></canvas>
            </div>
            {% endif %}
        </div>

        <!-- Row 2: Revenue Trend & Product Share -->
        <div class="charts-row chart-grid">
            {% if line_chart %}
            <div class="chart-container">
                <div class="chart-header">
                    <h3>Revenue Trend</h3>
                    <span class="chart-subtitle">Monthly performance</span>
                </div>
                <canvas id="monthlyTrendChart"></canvas>
            </div>
            {% endif %}

            {% if pie_chart %}
            <div class="chart-container">
                <div class="chart-header">
                    <h3>Product Share</h3>
                    <span class="chart-subtitle">Sales distribution</span>
                </div>
                <canvas id="productShareChart"></canvas>
            </div>
            {% endif %}
        </div>

        <!-- Row 3: Today's Sales -->
        <div class="charts-row chart-grid">
            {% if bar_chart %}
            <div class="chart-container">
                <div class="chart-header">
                    <h3>Today's Sales</h3>
                    <span class="chart-subtitle">Products sold today</span>
                </div>
                <canvas id="todaySalesChart"></canvas>
            </div>
            {% endif %}
        </div>

        <!-- Row 4: Map -->
        <div class="charts-row">
            {% if show_geo and geo_data %}
            <div class="chart-container chart-card">
                <div class="chart-header">
                    <h3>Geographic Distribution</h3>
                    <span class="chart-subtitle">All client locations</span>
                </div>
                <div id="client-map" style="width:100%; height:500px; border-radius:8px; border:1px solid #e5e7eb;"></div>
            </div>
            {% endif %}
        </div>

            <div class="chart-container chart-card">
        {% if table_chart %}
        <div class="chart-container wide">
            <div class="chart-header">
                <h3>Recent Transactions</h3>
                <span class="chart-subtitle">Last 10 bills</span>
            </div>
            <div class="table-wrapper" style="overflow-x:auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Client</th>
                            <th>Total</th>
                            <th>Items</th>
                        </tr>
                    </thead>
                    <tbody id="recentBillsBody">
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </div>

</div>

{% if debug and timings %}
<div class="timings-panel" style="margin-top:16px; padding:12px; border:1px dashed #e5e7eb; border-radius:8px; color:#6b7280;">
    <strong>Timings (ms):</strong>
    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:8px; margin-top:8px;">
        {% for k,v in timings.items %}
        <div style="background:#f9fafb; padding:8px 10px; border-radius:6px;">
            <span style="font-weight:600;">{{ k }}</span>: {{ v }}
        </div>
        {% endfor %}
    </div>
    <div style="margin-top:8px; font-size:0.9em;">Chart.js loaded via CDN once; charts rendered client-side. Leaflet map renders client locations dynamically.</div>
</div>
{% endif %}

<!-- Leaflet JS for map rendering -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<script>
    // Display current date (can run immediately)
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    });

    // Wait for window to fully load (including external scripts like Chart.js)
    window.addEventListener('load', function() {
        // Verify Chart.js is loaded
        if (typeof Chart === 'undefined') {
            console.error('Chart.js failed to load from CDN');
            return;
        }

        // Chart.js default configuration
        Chart.defaults.font.family = 'Inter, sans-serif';
        Chart.defaults.color = '#6b7280';
    
        // Top Clients Chart
        {% if top_clients_chart %}
        (function() {
            const data = {{ top_clients_chart|safe }};
            const ctx = document.getElementById('topClientsChart');
            if (ctx && data.labels && data.revenue) {
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Revenue ($)',
                        data: data.revenue,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '$' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(0);
                                }
                            }
                        }
                    }
                }
            });
        }
    })();
    {% endif %}
    
    // Top Products Chart
    {% if top_products_chart %}
    (function() {
        const data = {{ top_products_chart|safe }};
        const ctx = document.getElementById('topProductsChart');
        if (ctx && data.labels && data.quantity) {
            const quantityData = data.quantity.map(value => parseFloat(value));
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Quantity Sold',
                        data: quantityData,
                        backgroundColor: 'rgba(16, 185, 129, 0.8)',
                        borderColor: 'rgba(16, 185, 129, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
    })();
    {% endif %}
    
    // Monthly Trend Chart
    {% if line_chart %}
    (function() {
        const data = {{ line_chart|safe }};
        const ctx = document.getElementById('monthlyTrendChart');
        if (ctx && data.labels && data.revenue) {
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Monthly Revenue ($)',
                        data: data.revenue,
                        borderColor: 'rgba(99, 102, 241, 1)',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        tension: 0.4,
                        fill: true,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '$' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toFixed(0);
                                }
                            }
                        }
                    }
                }
            });
        }
    })();
    {% endif %}
    
    // Today's Sales Chart
    {% if bar_chart %}
    (function() {
        const data = {{ bar_chart|safe }};
        const ctx = document.getElementById('todaySalesChart');
        if (ctx && data.labels && data.quantity) {
            const quantityData = data.quantity.map(value => parseFloat(value));
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Quantity',
                        data: quantityData,
                        backgroundColor: 'rgba(245, 158, 11, 0.8)',
                        borderColor: 'rgba(245, 158, 11, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
    })();
    {% endif %}
    
    // Product Share Pie Chart
    {% if pie_chart %}
    (function() {
        const data = {{ pie_chart|safe }};
        const ctx = document.getElementById('productShareChart');
        if (ctx && data.labels && data.values) {
            const valuesData = data.values.map(value => parseFloat(value));
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: data.labels,
                    datasets: [{
                        data: valuesData,
                        backgroundColor: [
                            'rgba(99, 102, 241, 0.8)',
                            'rgba(16, 185, 129, 0.8)',
                            'rgba(245, 158, 11, 0.8)',
                            'rgba(239, 68, 68, 0.8)',
                            'rgba(139, 92, 246, 0.8)',
                            'rgba(236, 72, 153, 0.8)',
                            'rgba(14, 165, 233, 0.8)',
                            'rgba(34, 197, 94, 0.8)'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                boxWidth: 12,
                                padding: 10,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }
    })();
    {% endif %}
    
    // Recent Bills Table
    {% if table_chart %}
    (function() {
        const data = {{ table_chart|safe }};
        const tbody = document.getElementById('recentBillsBody');
        if (tbody && data && data.length > 0) {
            data.forEach(function(bill) {
                const tr = document.createElement('tr');
                tr.innerHTML = 
                    '<td>' + bill.date + '</td>' +
                    '<td>' + bill.client + '</td>' +
                    '<td>$' + bill.total.toFixed(2) + '</td>' +
                    '<td>' + bill.items + '</td>';
                tbody.appendChild(tr);
            });
        }
    })();
    {% endif %}

    // Initialize map with client locations if enabled
    {% if show_geo and geo_data %}
    (function() {
        const clientData = {{ geo_data|safe }};
        const mapElement = document.getElementById('client-map');
        
        if (mapElement && clientData && clientData.length > 0) {
            // Calculate center point from all clients
            let centerLat = 33.5731, centerLon = -7.5898; // Default Morocco
            if (clientData.length > 0) {
                const avgLat = clientData.reduce((sum, c) => sum + c.lat, 0) / clientData.length;
                const avgLon = clientData.reduce((sum, c) => sum + c.lon, 0) / clientData.length;
                centerLat = avgLat;
                centerLon = avgLon;
            }
            
            // Initialize Leaflet map centered on average client location
            const map = L.map('client-map').setView([centerLat, centerLon], 8);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            // Add markers for each client with actual geocoded coordinates
            const markers = [];
            const colors = ['red', 'blue', 'green', 'purple', 'orange', 'darkred', 'darkblue', 'darkgreen'];
            
            clientData.forEach(function(client, index) {
                const markerColor = colors[index % colors.length];
                
                // Create custom colored marker
                const customIcon = L.icon({
                    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-' + markerColor + '.png',
                    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                    iconSize: [25, 41],
                    iconAnchor: [12, 41],
                    popupAnchor: [1, -34],
                    shadowSize: [41, 41]
                });
                
                    // Use actual geocoded coordinates
                    const marker = L.marker([client.lat, client.lon], {
                        icon: customIcon,
                        title: client.name
                    }).bindPopup(
                        '<div style="text-align:center; min-width:200px;">' +
                        '<img src="' + client.profile_image + '" alt="' + client.name + '" style="width:80px; height:80px; border-radius:50%; border:3px solid #667eea; object-fit:cover; margin-bottom:8px;">' +
                        '<div style="font-weight:600; color:#1f2937; font-size:1em; margin-bottom:4px;">' + client.name + '</div>' +
                        '<div style="color:#6b7280; font-size:0.9em; margin-bottom:8px;">' + client.location + '</div>' +
                        (client.city ? '<div style="color:#9ca3af; font-size:0.85em;">üèôÔ∏è ' + client.city + '</div>' : '') +
                        (client.address ? '<div style="color:#9ca3af; font-size:0.85em;">üìç ' + client.address + '</div>' : '') +
                        (client.phone ? '<div style="color:#9ca3af; font-size:0.85em;">üìû ' + client.phone + '</div>' : '') +
                        '<div style="margin-top:10px;"><a href="/client/' + client.lid + '/" style="color:#667eea; text-decoration:none; font-weight:600; font-size:0.9em;">View & Update</a></div>' +
                        '</div>'
                    ).addTo(map);
                    
                    markers.push(marker);
            });
            
            // Auto-fit map bounds to show all markers
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }
    })();
    {% endif %}

    }); // End of window.addEventListener('load')
</script>
{% endblock content %}